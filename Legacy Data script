const fs = require("fs");

/* ================= CONFIG ================= */
const USERS = 12000;
const SHOPS = 800;
const PRODUCTS = 3000;
const VARIANTS_PER_PRODUCT = 4;
const ORDERS = 20000;

/* ================= UTILS ================= */
const rand = (min, max) =>
  Math.floor(Math.random() * (max - min + 1)) + min;

const pick = (arr) => arr[rand(0, arr.length - 1)];

const legacyDate = () => {
  const formats = [
    () => `${rand(1,28)}/${rand(1,12)}/2023`,
    () => `2023-${rand(1,12)}-${rand(1,28)}`,
    () => `${rand(1,28)}-${rand(1,12)}-23`,
    () => "INVALID_DATE"
  ];
  return pick(formats)();
};

/* ================= USERS ================= */
const users = [];
for (let i = 1; i <= USERS; i++) {
  users.push({
    user_id: i,
    username: `user_${i}`,
    phone: i % 50 === 0 ? null : `09${rand(10000000, 99999999)}`,
    is_active: pick([0, 1, "Y", "N"]),
    deleted_flag: i % 120 === 0 ? "Y" : "N",
    created_at: legacyDate()
  });
}

/* ================= SHOPS ================= */
const shops = [];
for (let i = 1; i <= SHOPS; i++) {
  shops.push({
    shop_id: i,
    shop_name: `SHOP_${i}`,
    owner_user_id: rand(1, USERS),
    rating_avg: i % 40 === 0 ? 7.8 : (Math.random() * 5).toFixed(2), // rating > 5
    is_official: pick([0, 1, "true", "false"]),
    created_at: legacyDate()
  });
}

/* ================= PRODUCTS ================= */
const products = [];
for (let i = 1; i <= PRODUCTS; i++) {
  products.push({
    product_id: i,
    shop_id: rand(1, SHOPS),
    product_name: `PRODUCT_${i}`,
    base_price:
      i % 55 === 0 ? -1000 : rand(10000, 500000), // price Ã¢m
    is_flash_sale: pick([0, 1, "Y", "N"]),
    created_at: legacyDate()
  });
}

/* ================= VARIANTS ================= */
const variants = [];
let variantId = 1;

products.forEach((p) => {
  for (let i = 0; i < VARIANTS_PER_PRODUCT; i++) {
    variants.push({
      variant_id: variantId++,
      product_id:
        variantId % 97 === 0 ? 999999 : p.product_id, // product khÃ´ng tá»“n táº¡i
      size: pick(["S", "M", "L", null]),
      color: pick(["RED", "BLUE", "BLACK", "???"]),
      stock_qty:
        variantId % 45 === 0 ? -5 : rand(0, 100), // kho Ã¢m
      price_override:
        variantId % 60 === 0 ? 0 : rand(8000, 450000),
      legacy_stock_flag: pick([0, 1, "Y", "N"])
    });
  }
});

/* ================= VOUCHERS ================= */
const vouchers = [];
for (let i = 1; i <= 500; i++) {
  vouchers.push({
    voucher_code: `VC_${i}`,
    discount_type: pick(["PERCENT", "FIXED", "UNKNOWN"]),
    discount_value: i % 30 === 0 ? 150 : rand(5, 50), // percent > 100
    min_order_value: rand(0, 300000),
    max_discount: rand(0, 200000),
    is_stackable: pick([0, 1, "Y", "N"]),
    expired_at: legacyDate()
  });
}

/* ================= ORDERS (FLASH SALE CHAOS) ================= */
const orders = [];
for (let i = 1; i <= ORDERS; i++) {
  const product = pick(products);
  const variant = pick(variants);

  orders.push({
    order_id: i,
    user_id:
      i % 88 === 0 ? 999999 : rand(1, USERS), // user khÃ´ng tá»“n táº¡i
    shop_id: product.shop_id,
    product_id: product.product_id,
    variant_id:
      i % 77 === 0 ? 888888 : variant.variant_id, // variant khÃ´ng tá»“n táº¡i
    qty:
      i % 66 === 0 ? 999 : rand(1, 5), // oversell
    price_at_time:
      i % 44 === 0 ? -5000 : variant.price_override,
    voucher_used:
      i % 3 === 0 ? pick(vouchers).voucher_code : "INVALID_VOUCHER",
    order_status: pick([
      "CREATED",
      "PAID",
      "CANCELLED",
      "UNKNOWN"
    ]),
    order_time:
      product.is_flash_sale == 1
        ? "01/12/2023 20:00" // flash sale cÃ¹ng thá»i Ä‘iá»ƒm
        : legacyDate()
  });
}

/* ================= WRITE FILES ================= */
fs.writeFileSync("legacy-users.json", JSON.stringify(users, null, 2));
fs.writeFileSync("legacy-shops.json", JSON.stringify(shops, null, 2));
fs.writeFileSync("legacy-products.json", JSON.stringify(products, null, 2));
fs.writeFileSync("legacy-variants.json", JSON.stringify(variants, null, 2));
fs.writeFileSync("legacy-vouchers.json", JSON.stringify(vouchers, null, 2));
fs.writeFileSync("legacy-orders.json", JSON.stringify(orders, null, 2));

console.log("ðŸ’£ Broken legacy e-commerce dataset generated");
